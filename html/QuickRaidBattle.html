<!DOCTYPE html>
<html>
<head>
    <title> GoBattleSim Quick Raid Battle </title>
	
	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
	
    <meta charset="utf-8">
    <meta name="viewport" 
          content="width=device-width">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">
	<link href="https://code.jquery.com/ui/jquery-ui-git.css" rel="stylesheet">
	
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/ui/jquery-ui-git.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"></script>
	
	<script src="./util.js"></script>

    <style>
		.sim-result {
			float: right;
		}
		
		.overlay {
		  height: 100%;
		  width: 100%;
		  position: fixed;
		  z-index: 1;
		  left: 0;
		  top: 0;
		  background-color: rgb(0,0,0);
		  background-color: rgba(0,0,0, 0.9);
		  overflow-x: hidden;
		  transition: 0.5s;
		}

		.overlay-content {
		  position: relative;
		  top: 40%;
		  width: 100%;
		  text-align: center;
		  margin-top: 30px;
		}
		
		.row, col-sm-3, col-sm-6 {
			padding-bottom: 6px;
		}
		
		
    </style>

	<script>
		var GameMaster = {};
		
		
		function autocomplete_pokemon_name(el) {
			$(el).autocomplete({
				minLength: 0,
				delay: 200,
				source: function(request, response){
					var matches = [];
					if (GameMaster.Pokemon) {
						for (var i = 0; i < GameMaster.Pokemon.length; ++i) {
							let pkm = GameMaster.Pokemon[i];
							if (pkm.name.includes (request.term.toLowerCase())) {
								matches.push(pkm.name);
							}
						}
					}
					response(matches);
				}
			});
		}
		
		
		function autocomplete_move_name(el) {
			var moveType = $(el).attr("name").includes("fmove") ? "fast" : "charged";
			$(el).autocomplete({
				minLength: 0,
				delay: 200,
				source: function(request, response){
					var matches = [];
					if (request.term == "") {
						var pkm_name = $("#SimInputForm-" + $(el).attr("name").split("-")[0] + "-name").val();
						for (var i = 0; i < GameMaster.Pokemon.length; ++i) {
							let pkm = GameMaster.Pokemon[i];
							if (pkm.name == pkm_name) {
								matches = pkm[moveType + "Moves"];
								break;
							}
						}
						if (matches.length == 0) {
							matches = GameMaster.PvEMoves.filter(x => x.movetype == moveType).map(x => x.name);
						}
					} else {
						for (var i = 0; i < GameMaster.PvEMoves.length; ++i) {
							let move = GameMaster.PvEMoves[i];
							if (move.name.includes(request.term.toLowerCase())) {
								matches.push(move.name);
							}
						}
					}
					response(matches);
				}
			});
			
			$(el).on("focus", function(){
				$(this).autocomplete("search", "");
			});
		}		
		
	

		$(document).ready(function(){		
			const urlParams = new URLSearchParams(window.location.search);
			const myParam = urlParams.get('myParam');
			
			GBS.submit("GetGameMaster", {}, function(reqOutput){
				GameMaster = reqOutput;
			});
			
			
			autocomplete_pokemon_name("#SimInputForm-attacker-name");
			autocomplete_pokemon_name("#SimInputForm-boss-name");
			autocomplete_move_name("#SimInputForm-attacker-fmove");
			autocomplete_move_name("#SimInputForm-attacker-cmove");
			autocomplete_move_name("#SimInputForm-boss-fmove");
			autocomplete_move_name("#SimInputForm-boss-cmove");
			
			
			$('#SimInputForm').submit(function (evt) {
				evt.preventDefault();

				var reqInput = {
					"GameMaster": GameMaster
				};
				for (var i = 0; i < evt.currentTarget.length; ++i) {
					var key = evt.currentTarget[i].name;
					var val = evt.currentTarget[i].value;
					if (key.includes('-')) {
						var path = key.split('-');
						var cur = reqInput;
						for (var j = 0; j < path.length - 1; j++) {
							if (cur[path[j]] == undefined) {
								cur[path[j]] = {};
							}
							cur = cur[path[j]];
						}
						cur[path[path.length - 1]] = try_parse(val);
					} else if (key) {
						reqInput[key] = try_parse(val);
					}
				}
				
				$("#running-screen").toggle(true);
				GBS.submit("QuickRaidBattle", reqInput, function(reqOutput){
					for (var attr in reqOutput) {
						$("#SimOutput-" + attr).text(reqOutput[attr]);
					}
					
					if (reqOutput.win > 0.8) {
						$("#SimOutput-win").attr("class", "sim-result alert alert-success");
					} else if (reqOutput.win > 0.2) {
						$("#SimOutput-win").attr("class", "sim-result alert alert-warning");
					} else {
						$("#SimOutput-win").attr("class", "sim-result alert alert-danger");
					}
					
					if (reqOutput.tdo_percent >= 1) {
						$("#SimOutput-tdo_percent").attr("class", "sim-result alert alert-success");
					} else if (reqOutput.tdo_percent > 0.8) {
						$("#SimOutput-tdo_percent").attr("class", "sim-result alert alert-warning");
					} else {
						$("#SimOutput-tdo_percent").attr("class", "sim-result alert alert-danger");
					}
				}, function(){
					$("#running-screen").toggle(false);
				});

			});
		});
	</script>
	
	
</head>
<body>

	<div class="py-5 text-center">
		<img class="d-block mx-auto mb-4" src="pogo_gamepress_logo.jpg" alt="" width="72" height="72">
		<h2>Quick Raid Battle</h2>
		<p class="lead">Easy-to-use raid battle simulator.</p>
	</div>
	

    <div id="SimInputFormContainer" class="container page pb-3">
      
	  <h4> Simulation Input </h4>

	  <form id="SimInputForm">
		
		<div class="form-group">
		<div class="row">
			<div class="col-sm-6">
				<label for="SimInputForm-attacker-name">Attacker Name</label>
				<input required type="text" class="form-control" id="SimInputForm-attacker-name" name="attacker-name" value='machamp' />
			</div>
			<div class="col-sm-3">
				<label for="SimInputForm-attacker-fmove">Fast Move</label>
				<input required type="text" class="form-control" id="SimInputForm-attacker-fmove" name="attacker-fmove" value='counter' />
			</div>
			<div class="col-sm-3">
				<label for="SimInputForm-attacker-cmove">Charged Move</label>
				<input required type="text" class="form-control" id="SimInputForm-attacker-cmove" name="attacker-cmove" value='dynamic punch' />
			</div>
			<div class="col-sm">
				<a data-toggle="collapse" href="#SimInputForm-attacker-advance">More Attacker Options</a>
			</div>
		</div>
		</div>
		
		
		<div id="SimInputForm-attacker-advance" class="collapse">
			<div class="form-group">
			<div class="row">
				<div class="col-sm-3">
					<label for="SimInputForm-attacker-level">Level</label>
					<input required type="number" class="form-control" id="SimInputForm-attacker-level" name="attacker-level" min="1" max="40" value="40" />
				</div>
				<div class="col-sm-3">
					<label for="SimInputForm-attacker-atkiv">Atk IV</label>
					<input required type="number" class="form-control" id="SimInputForm-attacker-atkiv" name="attacker-atkiv" min="0" max="15" value="15" />
				</div>
				<div class="col-sm-3">
					<label for="SimInputForm-attacker-defiv">Def IV</label>
					<input required type="number" class="form-control" id="SimInputForm-attacker-defiv" name="attacker-defiv" min="0" max="15" value="15" />
				</div>
				<div class="col-sm-3">
					<label for="SimInputForm-attacker-atkiv">HP IV</label>
					<input required type="number" class="form-control" id="SimInputForm-attacker-stmiv" name="attacker-stmiv" min="0" max="15" value="15" />
				</div>
			</div>
			</div>
			
			<div class="form-group">
			<div class="row">
				<div class="col-sm-3">
					<label for="SimInputForm-party_size">Party Size</label>
					<input required type="number" class="form-control" id="SimInputForm-party_size" name="party_size" min="1" max="6" value="6" />
				</div>
				<div class="col-sm-3">
					<label for="SimInputForm-player_multiplier">Player Multiplier</label>
					<input required type="number" class="form-control" id="SimInputForm-player_multiplier" name="player_multiplier" min="1" max="20" value="1" />
				</div>
				<div class="col-sm-3">
					<label for="SimInputForm-strategy">Strategy</label>
					<select required type="number" class="form-control" id="SimInputForm-strategy" name="strategy" value="1">
						<option value="1">No Dodge</option>
						<option value="2">Dodge Specials</option>
						<option value="3">Dodge All</option>
					</select>
				</div>
				<div class="col-sm-3">
					<label for="SimInputForm-rejoin">Rejoin</label>
					<select input required type="required" class="form-control" id="SimInputForm-rejoin" name="rejoin" value="0" >
						<option value="0">Never</option>
						<option value="-1">Forever</option>
						<option value="1">Once</option>
						<option value="2">Twice</option>
					</select>
				</div>
			</div>
			</div>
		</div>
		 
		<div class="form-group">
		<div class="row">
			<div class="col-sm-3">
				<label for="SimInputForm-boss-name">Boss Name</label>
				<input required type="text" class="form-control" id="SimInputForm-boss-name" name="boss-name" value='tyranitar' />
			</div>
			<div class="col-sm-3">
				<label for="SimInputForm-boss-name">Tier</label>
				<select required type="number" class="form-control" id="SimInputForm-boss-tier" name="boss-tier" value='4' />
					<option value="1">Tier 1</option>
					<option value="2">Tier 2</option>
					<option value="3">Tier 3</option>
					<option value="4">Tier 4</option>
					<option value="5">Tier 5</option>
				</select>
			</div>
			<div class="col-sm-3">
				<label for="SimInputForm-boss-fmove">Fast Move</label>
				<input required type="text" class="form-control" id="SimInputForm-boss-fmove" name="boss-fmove" value='bite' />
			</div>
			<div class="col-sm-3">
				<label for="SimInputForm-boss-cmove">Charged Move</label>
				<input required type="text" class="form-control" id="SimInputForm-boss-cmove" name="boss-cmove" value='crunch' />
			</div>
		</div>
		</div>
		
		<div class="form-group">
		<div class="row">
			<div class="col-sm-6">
				<label for="SimInputForm-friend">Friend Level</label>
				<select required type="number" class="form-control" id="SimInputForm-friend" name="friend" value="0">
					<option value="0">Level 0: None</option>
					<option value="1">Level 1: Good</option>
					<option value="2">Level 2: Great</option>
					<option value="3">Level 3: Ultra</option>
					<option value="4">Level 4: Best</option>
				</select>
			</div>
			<div class="col-sm-6">
				<label for="SimInputForm-weather">Weather</label>
				<select required class="form-control" id="SimInputForm-weather" name="weather" value="extreme">
					<option value="extreme">Extreme</option>
					<option value="sunny">Sunny</option>
					<option value="partly Cloudy">Partly Cloudy</option>
					<option value="cloudy">Cloudy</option>
					<option value="rainy">Rainy</option>
					<option value="windy">Windy</option>
					<option value="snow">Snow</option>
					<option value="fog">Fog</option>
				</select>
			</div>
		 
			<div class="col-sm">
				<a data-toggle="collapse" href="#SimInputForm-general-advance">More General Options</a>
			</div>
		</div>
		</div>
		
		<div id="SimInputForm-general-advance" class="collapse">
			<div class="form-group">
			<div class="row">
				<div class="col-sm-6">
					<label for="SimInputForm-num_sims">Number of Simulations</label>
					<input required type="number" class="form-control" id="SimInputForm-num_sims" name="num_sims" max="10000" value="1000" />
				</div>
				<div class="col-sm-6">
					<label for="SimInputForm-num_sims">Random Seed</label>
					<input required type="number" class="form-control" id="SimInputForm-random_seed" name="random_seed" value="0" />
				</div>
			</div>
			</div>
		</div>
		
		<div class="form-group">
		<div class="row">
			<div class="col-sm-3">
			</div>
			<div class="col-sm-6">
				<button type="submit" class="btn btn-primary" style="width: 100%">Submit</button>
			</div>
			<div class="col-sm-3">
			</div>
		</div>
		</div>
		 
	  </form>
	
	</div>
	 
	 
	<div id="SimOutputContainer" class="container page pb-3">
	
		<h4> Simulation Output </h4>
		
		<div class="form-group">
		<div class="row">
			<div class="col-sm-6">
				<label for="SimOutput-win">Win Rate</label>
				<span class="sim-result alert alert-primary" id="SimOutput-win"></span>
			</div>
			<div class="col-sm-6">
				<label for="SimOutput-duration">Average Duration</label>
				<span class="sim-result alert alert-primary" id="SimOutput-duration"></span>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-6">
				<label for="SimOutput-tdo_percent">Average TDO%</label>
				<span class="sim-result alert alert-primary" id="SimOutput-tdo_percent"></span>
			</div>
			<div class="col-sm-6">
				<label for="SimOutput-num_deaths">Average # of Deaths</label>
				<span class="sim-result alert alert-primary" id="SimOutput-num_deaths"></span>
			</div>
		</div>
		</div>
	</div>
	
	<div class="overlay" id="running-screen" style="display: none">
		<div class="overlay-content" >
			<div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" ></div>
		</div>
    </div>

    
</body>
</html>
